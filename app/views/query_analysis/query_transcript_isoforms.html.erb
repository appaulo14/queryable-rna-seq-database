<%= render 'shared/error_messages', :object => @qti %>
<script type='text/javascript' src='query_transcript_isoforms.js' ></script>
<%= javascript_include_tag 'downloadify/swfobject.js' %>
<%= javascript_include_tag 'downloadify/downloadify.min.js' %>
<%= javascript_include_tag 'Stupid-Table-Plugin/stupidtable.min.js' %>
<%= form_for(@qti, :url => '/query_analysis/query_transcript_isoforms') do |qti| %>
  <h1>Please select your novel isoforms and other transcript classification search options</h1>
  <p>
    <%= qti.label :dataset_id, "Dataset to query" %>
    <%= qti.select :dataset_id, options_for_select(@qti.names_and_ids_for_available_datasets, @qti.dataset_id) %><br/>
    <%= #qti.label :samples_to_compare, "Samples to compare" 
    %>
    <%= #qti.select :samples_to_compare, options_for_select(@qti.available_samples_for_comparison) 
    %>
    <%= label :sample_id, "Select Sample" %>
    <%= qti.select :sample_id, options_for_select(@qti.available_samples,@qti.sample_id)  %> 
  </p>
  <h2>Query filtering options</h2>
  <p>
    <div>
        <table>
        <tr>
          <td class='rounded-corners sub-section' style='padding-right:10px'>
            <%= qti.check_box(:class_code_equal) %>
            <%= qti.label(:class_code_equal, '=') %>
          </td>
          <td class='rounded-corners sub-section' style='padding-right:10px'>
            <%= qti.check_box(:class_code_c) %>
            <%= qti.label(:class_code_c, 'c') %>
          </td>
          <td class='rounded-corners sub-section' style='padding-right:10px'>
            <%= qti.check_box(:class_code_j) %>
            <%= qti.label(:class_code_j, 'j') %>
          </td>
          <td class='rounded-corners sub-section' style='padding-right:10px'>
            <%= qti.check_box(:class_code_e) %>
            <%= qti.label(:class_code_e, 'e') %>
          </td>
          <td class='rounded-corners sub-section' style='padding-right:10px'>
            <%= qti.check_box(:class_code_i) %>
            <%= qti.label(:class_code_i, 'i') %>
          </td>
          <td class='rounded-corners sub-section' style='padding-right:10px'>
            <%= qti.check_box(:class_code_o) %>
            <%= qti.label(:class_code_o, 'o') %>
          </td>
          <td class='rounded-corners sub-section' style='padding-right:10px'>
            <%= qti.check_box(:class_code_p) %>
            <%= qti.label(:class_code_p, 'p') %>
          </td>
          <td class='rounded-corners sub-section' style='padding-right:10px'>
            <%= qti.check_box(:class_code_r) %>
            <%= qti.label(:class_code_r, 'r') %>
          </td>
          <td class='rounded-corners sub-section' style='padding-right:10px'>
            <%= qti.check_box(:class_code_u) %>
            <%= qti.label(:class_code_u, 'u') %>
          </td>
          <td class='rounded-corners sub-section' style='padding-right:10px'>
            <%= qti.check_box(:class_code_x) %>
            <%= qti.label(:class_code_x, 'x') %>
          </td>
          <td class='rounded-corners sub-section' style='padding-right:10px'>
            <%= qti.check_box(:class_code_s) %>
            <%= qti.label(:class_code_s, 's') %>
          </td>
          <td class='rounded-corners sub-section' style='padding-right:10px'>
            <%= qti.check_box(:class_code_dot) %>
            <%= qti.label(:class_code_dot, '.') %>
          </td>
          <td>
            <%= link_to('See Class Code Definitions','http://cufflinks.cbcb.umd.edu/manual.html#class_codes', :target => '_blank') %>
          </td>
        </tr>
        </table>
    </div>
    <div>
        <%= qti.label(:go_terms, "GO Terms, separated by semicolons") %>
        <%= qti.text_field(:go_terms, :size => 70) %>
        <%= link_to('Browse GO Terms','http://amigo.geneontology.org/cgi-bin/amigo/browse.cgi', :target => '_blank') %>
    </div>
    <div>
        <%= qti.label(:go_ids, "GO IDs (a.k.a Accessions), separated by semicolons") %>
        <%= qti.text_field(:go_ids) %>
        <%= link_to('Browse GO Terms','http://amigo.geneontology.org/cgi-bin/amigo/browse.cgi', :target => '_blank') %>
    </div>
    <div>
        <%= label(:transcript_length, "Transcript length") %>
        <%= qti.select(:transcript_length_comparison_sign, 
            options_for_select(qti.object.available_transcript_length_comparison_signs,
              qti.object.transcript_length_comparison_sign)) %>
        <%= qti.text_field(:transcript_length_value) %>
    </div>
    <div>
        <%= qti.label(:transcript_name, "Transcript name:") %>
        <%= qti.text_field(:transcript_name) %>
    </div>
  </p>
  <p><%= submit_tag('Query', :disable_with => 'Querying...', :id => :submit_query) %></p>
<% end %>
<!--Section for the query results-->
<% if @qti.show_results? %>
  <p><%= @qti.results.length %> results found for <em><b><%= @qti.sample_name %></b></em></p>
  <p id="downloadify">
      You must have Flash 10 installed to download this file.
  </p>
  <!--Table containing the query results-->
  <table border="1" id="query_results_table">
      <thead>
          <tr>
              <th data-sort='string'>Transcript&nbsp;<%= neutral_sort_arrow %></th>
              <th data-sort='string'>Associated Gene&nbsp;<%= neutral_sort_arrow %></th>
              <th>GO Terms</th>
              <th data-sort='string'>Class Code&nbsp;<%= neutral_sort_arrow %></th>
              <th data-sort='float'>Transcript length&nbsp;<%= neutral_sort_arrow %></th>
              <th data-sort='float'>Coverage&nbsp;<%= neutral_sort_arrow %></th>
              <th data-sort='float'>FPKM&nbsp;<%= neutral_sort_arrow %></th>
              <th data-sort='float'>FPKM Lower Bound&nbsp;<%= neutral_sort_arrow %></th>
              <th data-sort='float'>FPKM Upper Bound&nbsp;<%= neutral_sort_arrow %></th>
              <th data-sort='string'>Quantification Status&nbsp;<%= neutral_sort_arrow %></th>
          </tr>
      </thead>
      <tbody>
          <% @qti.results.each do |result| %>
              <tr>
                <td data-sort-value="<%= result[:transcript_name] %>">
                  <%= link_to_fasta_sequence_for_transcript(@qti.dataset_id, result[:transcript_name]) %>
                </td>
                <td data-sort-value="<%= result[:gene_name] %>">
                  <%= link_to_fasta_sequences_for_gene(@qti.dataset_id, result[:gene_name]) %>
                </td>
                  
                <% if result[:go_terms].empty? == false %>
                  <td data-sort-value="<%= result[:go_terms].to_s %>">
                    <ul>
                      <!-- Sort by ascending GO ID for the go terms-->
                      <% result[:go_terms].sort{|a,b| a.id.gsub(/GO:/,'').to_i <=> b.id.gsub(/GO:/,'').to_i}.each do |go_term| %>
                        <li><%= link_to_amigo_web_page_for_term("#{go_term.term} [#{go_term.id}]",go_term.id) %></li>
                      <% end %>
                    </ul>
                  </td>
                <% else %>
                  <td>
                    No GO ids found.
                  </td>
                <% end %>
                <td data-sort-value="<%= result[:class_code] %>">
                  <%= result[:class_code] %>
                </td>
                <td data-sort-value="<%= result[:transcript_length] %>">
                  <%= result[:transcript_length] %>
                </td>
                <td data-sort-value="<%= result[:coverage] %>">
                  <%= result[:coverage].to_d.round(3) %>
                </td>
                <td data-sort-value="<%= result[:fpkm] %>">
                  <%= result[:fpkm].to_d.round(3) %>
                </td>
                <td data-sort-value="<%= result[:fpkm_lo] %>">
                  <%= result[:fpkm_lo].to_d.round(3) %>
                </td>
                <td data-sort-value="<%= result[:fpkm_hi] %>">
                  <%= result[:fpkm_hi].to_d.round(3) %>
                </td>
                <td data-sort-value="<%= result[:status] %>">
                  <%= result[:status] %>
                </td>
              </tr>
          <% end %>
      </tbody>
  </table>
<% end %>
