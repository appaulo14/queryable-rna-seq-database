query_info = {};

jQuery(document).ready(function($) {
  $( "#new_" + view_info.action ).on( "submit", function( event ) {
    event.preventDefault();
    prepare_for_querying();
  });
});

function prepare_for_querying(){
  query_info.want_new_query = true;
  if (query_info.query_running == true){
    setTimeout(prepare_for_querying,0);  
    return;
  }
  query_info.want_new_query = false;
  query_info.query_running = true;
  $('#query_results_div').css('display','block');
  $('#query_transcript_isoforms_piece').val(0);
  $('#querying_indicator').css('display','block');
  if (view_info.action == "query_transcript_isoforms"){
    sample_name = $("#"+ view_info.action + "_sample_id option:selected").text();
    $('#results_for').text(sample_name);
  }
  else{
    selector = "#"+ view_info.action + "_sample_comparison_id option:selected";
    sample_cmp_name = $(selector).text();
    $('#results_for').text(sample_name);
  }
  $('#num_results_found').text("0 records found so far");
  $('#insert_query_results_here').html("");
  query_info.params = $("#new_" + view_info.action).serializeArray();
  get_next_piece();
}

function get_next_piece(){;
  if (query_info.want_new_query == true){
    query_info.query_running = false;
    return;
  }
  piece_param = $('#' + view_info.action + '_piece').serializeArray();
  $.post(view_info.action, 
      query_info.params.concat(piece_param)
  ).done(success)
   .fail(post_failed);
}

function success(html){
  //alert('success');
  if (query_info.want_new_query == true){
    query_info.query_running = false;
    return;
  }
  tbody = $('#insert_query_results_here');
  tbody.append(html);
  records_found = $('#insert_query_results_here tr').length;
  if (html.length > 0){
    old_val = $('#' + view_info.action + '_piece').val();
    $('#' + view_info.action + '_piece').val(parseInt(old_val)+1);
    $('#num_results_found').text(records_found + " records found so far");
    get_next_piece();
  }
  else{
    query_info.query_running = false;
    $('#querying_indicator').css('display','none');
    $('#num_results_found').text(records_found + " records found");
//     $(ths[0]).trigger('click');
//     $(ths[1]).trigger('click');
//     $(ths[0]).trigger('click');
  }
}

function post_failed(){
  $('#querying_indicator').css('display','none');
  query_info.query_running = false;
}
 
